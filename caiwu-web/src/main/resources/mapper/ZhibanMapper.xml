<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhimeng.caiwuweb.dao.ZhibanMapper">
  <resultMap id="BaseResultMap" type="com.zhimeng.caiwuweb.entity.Zhiban">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="zhiban_id" jdbcType="VARCHAR" property="zhibanId" />
    <result column="cus_name" jdbcType="VARCHAR" property="cusName" />
    <result column="zhiban_time" jdbcType="TIMESTAMP" property="zhibanTime" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="zhiban_money" jdbcType="DOUBLE" property="zhibanMoney" />
    <result column="paixu" jdbcType="DOUBLE" property="paixu" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="table_type" jdbcType="INTEGER" property="tableType" />
    <result column="record_time" jdbcType="TIMESTAMP" property="recordTime" />
    <result column="zhiban_region" jdbcType="TIMESTAMP" property="zhibanRegion" />
    <result column="batch_number" jdbcType="TIMESTAMP" property="batchNumber" />
    <result column="id" jdbcType="INTEGER" property="id" />
    <result column="repetition" jdbcType="INTEGER" property="repetition" />
  </resultMap>

  <sql id="Base_Column_List">
 zhiban_id, cus_name, zhiban_time,
      remark, case when zhiban_money is null then 0 else zhiban_money end as zhiban_money, paixu,
      status, table_type,record_time,zhiban_region,batch_number,id,repetition
  </sql>

  <select id="selectByNameTime" parameterType="com.zhimeng.caiwuweb.entity.Zhiban" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from zhiban where cus_name=#{cusName,jdbcType=VARCHAR} and status = 0 and zhiban_time=#{zhibanTime,jdbcType=TIMESTAMP}
      and repetition = 0
      <if test="cusRegion != null">
          and zhiban_region =  #{cusRegion,jdbcType=VARCHAR}
      </if>
  </select>

  <select id="selectByName" parameterType="java.lang.String" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from zhiban where cus_name=#{cusName,jdbcType=VARCHAR}
</select>

    <select id="selectById" parameterType="com.zhimeng.caiwuweb.entity.Zhiban" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from zhiban
        <where>
            <if test="id != null">
                id=#{id,jdbcType=INTEGER}
            </if>
            <if test="status != null">
              and  status=#{status,jdbcType=INTEGER}
            </if>
            <if test="repetition != null">
              and  repetition=#{repetition,jdbcType=INTEGER}
            </if>
        </where>
    </select>


    <select id="selectByBatchNumber" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from zhiban where batch_number=#{batchNumber,jdbcType=VARCHAR}
        <if test="cusRegion != null">
            and zhiban_region in = #{cusRegion,jdbcType=VARCHAR}
        </if>
    </select>


    <select id="selectByNameStatus" parameterType="com.zhimeng.caiwuweb.entity.Zhiban" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from zhiban where cus_name=#{cusName,jdbcType=VARCHAR} and status=#{status,jdbcType=INTEGER}
        <if test="cusRegion != null">
            and zhiban_region = #{cusRegion,jdbcType=VARCHAR}
        </if>
    </select>

    <select id="selectByCoding" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from zhiban
        <where>
            <if test="cusRegion != null">
                zhiban_region = #{cusRegion,jdbcType=VARCHAR}
            </if>
            <if test="zhibanId != null">
                and zhiban_id=#{zhibanId,jdbcType=VARCHAR}
            </if>
            <if test="status != null">
             and   status =#{status,jdbcType=INTEGER}
            </if>
            <if test="repetition != null">
              and  repetition =#{repetition,jdbcType=INTEGER}
            </if>
        </where>
    </select>

    <select id="selectByid" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List" />
        from zhiban where id=#{id,jdbcType=INTEGER} and status = 0
    </select>

  <select id="selectBetweenTime" parameterType="com.zhimeng.caiwuweb.entity.DateVo" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from zhiban
    where zhiban_time between #{start}  and #{end}
  </select>

    <select id="selectAll" parameterType="com.zhimeng.caiwuweb.entity.Zhiban" resultMap="BaseResultMap">

        select
        <include refid="Base_Column_List" />
        from zhiban
        <where>

            <if test="cusName != null">
                cus_name=#{cusName,jdbcType=INTEGER}
            </if>
            <if test="status != null">
                AND status=#{status,jdbcType=INTEGER}
            </if>

            <!-- 判断是不是超级管理员,超级管理员需要查询本级及下级 -->
            <choose>
                <when test="cusAuthority != null and zhibanRegion != null">
                    and zhiban_region in (
                    SELECT
                    case
                    when t3.cityname is not null then t3.cityname
                    when t2.cityname is not null then t2.cityname
                    when t1.cityname is not null then t1.cityname
                    end as cityname
                    FROM (select id,cityname,pid from city where type = 5) t1
                    LEFT JOIN (select id,cityname,pid from city where type = 5) t2 ON t1.id = t2.pid
                    LEFT JOIN (select id,cityname,pid from city where type = 5) t3 ON t2.id = t3.pid
                    WHERE t1.cityname = #{zhibanRegion,jdbcType=VARCHAR}
                    )
                </when>
                <when test="zhibanRegion != null">
                    AND  zhiban_region = #{zhibanRegion,jdbcType=VARCHAR}
                </when>
                <otherwise>
                    and 1 = 1
                </otherwise>
            </choose>


          <!--  <if test="zhibanRegion != null">
                AND  zhiban_region = #{zhibanRegion,jdbcType=VARCHAR}
            </if>-->
            <if test="repetition != null">
                <!-- 注释掉查询不重复的，将所有重复的没重复的全部展示出来-->
                AND  repetition=#{repetition,jdbcType=INTEGER}
            </if>
            <if test="zhibanTime != null">
                AND zhiban_time >= #{recordTime,jdbcType=TIMESTAMP} and zhiban_time &lt;=#{zhibanTime,jdbcType=TIMESTAMP}
            </if>
            <!-- 添加单位查询过滤,2020.06.17 -->
            <if test="unit != null">
                AND  zhiban_region in
                (
                SELECT
                case
                when t3.cityname is not null then t3.cityname
                when t2.cityname is not null then t2.cityname
                when t1.cityname is not null then t1.cityname
                end as cityname
                FROM (select id,cityname,pid from city where type = 5) t1
                LEFT JOIN (select id,cityname,pid from city where type = 5) t2 ON t1.id = t2.pid
                LEFT JOIN (select id,cityname,pid from city where type = 5) t3 ON t2.id = t3.pid
                WHERE t1.id = #{unit,jdbcType=VARCHAR}
                )
            </if>
        </where>
        <if test="paixu != null">
            order by  cus_name,repetition,record_time asc
        </if>
        <if test="paixu == null">
            order by  cus_name,repetition,record_time desc
        </if>
    </select>

    <update id="deleteByCoding" parameterType="java.lang.Integer">
        update zhiban set
          status=1
        where id = #{id}
    </update>

  <insert id="insert" parameterType="com.zhimeng.caiwuweb.entity.Zhiban">
      insert into zhiban (zhiban_id, cus_name, zhiban_time,
      remark, zhiban_money, paixu,
      status, table_type,record_time,zhiban_region,batch_number)
    values (#{zhibanId,jdbcType=VARCHAR}, #{cusName,jdbcType=VARCHAR}, #{zhibanTime,jdbcType=TIMESTAMP},
      #{remark,jdbcType=VARCHAR}, #{zhibanMoney,jdbcType=DOUBLE}, #{paixu,jdbcType=INTEGER},
      #{status,jdbcType=INTEGER}, #{tableType,jdbcType=INTEGER}, #{recordTime,jdbcType=TIMESTAMP},#{zhibanRegion,jdbcType=VARCHAR},#{batchNumber,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.zhimeng.caiwuweb.entity.Zhiban">
      insert into zhiban
      <trim prefix="(" suffix=")" suffixOverrides=",">
          <if test="zhibanId != null">
              zhiban_id,
          </if>
          <if test="id != null">
              id,
          </if>
          <if test="cusName != null">
              cus_name,
          </if>
          <if test="zhibanTime != null">
              zhiban_time,
          </if>
          <if test="remark != null">
              remark,
          </if>
          <if test="zhibanMoney != null">
              zhiban_money,
          </if>
          <if test="paixu != null">
              paixu,
          </if>
          <if test="status != null">
              status,
          </if>
          <if test="tableType != null">
              table_type,
          </if>
          <if test="recordTime != null">
              record_time,
          </if>
          <if test="zhibanRegion != null">
              zhiban_region,
          </if>
          <if test="batchNumber != null">
              batch_number,
          </if>
          <if test="repetition != null">
              repetition,
          </if>
      </trim>
      <trim prefix="values (" suffix=")" suffixOverrides=",">
          <if test="zhibanId != null">
              #{zhibanId,jdbcType=VARCHAR},
          </if>
          <if test="id != null">
              #{id,jdbcType=INTEGER},
          </if>
          <if test="cusName != null">
              #{cusName,jdbcType=VARCHAR},
          </if>
          <if test="zhibanTime != null">
              #{zhibanTime,jdbcType=TIMESTAMP},
          </if>
          <if test="remark != null">
              #{remark,jdbcType=VARCHAR},
          </if>
          <if test="zhibanMoney != null">
              #{zhibanMoney,jdbcType=DOUBLE},
          </if>
          <if test="paixu != null">
              #{paixu,jdbcType=INTEGER},
          </if>
          <if test="status != null">
              #{status,jdbcType=INTEGER},
         </if>
          <if test="tableType != null">
              #{tableType,jdbcType=INTEGER},
          </if>
          <if test="recordTime != null">
              #{recordTime,jdbcType=TIMESTAMP},
          </if>
          <if test="zhibanRegion != null">
              #{zhibanRegion,jdbcType=VARCHAR},
          </if>
          <if test="batchNumber != null">
              #{batchNumber,jdbcType=VARCHAR},
          </if>
          <if test="repetition != null">
              #{repetition,jdbcType=INTEGER},
          </if>
      </trim>
  </insert>

    <update id="updateByPrimaryKeySelective" parameterType="com.zhimeng.caiwuweb.entity.Zhiban">
        update zhiban
        <set>
            <if test="cusName != null">
                cus_name=#{cusName,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status=#{status,jdbcType=VARCHAR},
            </if>
            <if test="zhibanTime != null">
                zhiban_time=#{zhibanTime,jdbcType=TIMESTAMP},
            </if>
            <if test="remark != null">
                remark=#{remark,jdbcType=VARCHAR},
            </if>
            <if test="zhibanMoney != null">
                zhiban_money=#{zhibanMoney,jdbcType=VARCHAR},
            </if>
            <if test="zhibanRegion != null">
                zhiban_region=#{zhibanRegion,jdbcType=VARCHAR},
            </if>
            <if test="batchNumber != null">
                batch_number=#{batchNumber,jdbcType=VARCHAR},
            </if>
            <if test="repetition != null">
                repetition=#{repetition,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="updateByzhiban" parameterType="com.zhimeng.caiwuweb.entity.Zhiban">
        update zhiban
        <set>
            <if test="cusName != null">
                cus_name=#{cusName,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status=#{status,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                remark=#{remark,jdbcType=VARCHAR},
            </if>
            <if test="zhibanMoney != null">
                zhiban_money=#{zhibanMoney,jdbcType=VARCHAR},
            </if>
            <if test="zhibanRegion != null">
                zhiban_region=#{zhibanRegion,jdbcType=VARCHAR},
            </if>
            <if test="batchNumber != null">
                batch_number=#{batchNumber,jdbcType=VARCHAR},
            </if>
            <if test="repetition != null">
                repetition=#{repetition,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="updateByCodingzhiban" parameterType="com.zhimeng.caiwuweb.entity.Zhiban">
        update zhiban
        <set>
            <if test="cusName != null">
                cus_name=#{cusName,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status=#{status,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                remark=#{remark,jdbcType=VARCHAR},
            </if>
            <if test="zhibanMoney != null">
                zhiban_money=#{zhibanMoney,jdbcType=VARCHAR},
            </if>
            <if test="zhibanRegion != null">
                zhiban_region=#{zhibanRegion,jdbcType=VARCHAR},
            </if>
            <if test="batchNumber != null">
                batch_number=#{batchNumber,jdbcType=VARCHAR},
            </if>
            <if test="repetition != null">
                repetition=#{repetition,jdbcType=INTEGER},
            </if>
        </set>
        where zhiban_id = #{zhibanId,jdbcType=VARCHAR}
    </update>

</mapper>